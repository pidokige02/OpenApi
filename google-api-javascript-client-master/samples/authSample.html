<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Say hello using the People API</title>
</head>
<body>
  <p>Say hello using the People API.</p>

  <!-- Add button to sign in and sign out -->
  <button id="authorize-button">Authorize</button>
  <button id="signout-button" style="display: none;">Sign Out</button>

  <div id="content"></div>

  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script>
    var clientId;
    var apiKey;
    var scopes = 'https://www.googleapis.com/auth/userinfo.profile';

    var tokenClient;
    var accessToken = null;
    // 서버에서 secrets(apiKey, clientId)를 가져옴
    async function fetchSecrets() {
      try {
        const response = await fetch('http://localhost:3001/api/secrets');
        const secrets = await response.json();
        clientId = secrets.clientId;
        apiKey = secrets.apiKey;
        console.log('Secrets fetched:', clientId, apiKey);
        initializeGis(); // Secrets을 가져온 후 GIS 초기화
      } catch (error) {
        console.error('Error fetching secrets:', error);
      }
    }

    function initializeGis() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: clientId,
        scope: scopes,
        callback: (response) => {
          if (response.error) {
            console.error(response.error);
            return;
          }
          accessToken = response.access_token;
          makeApiCall();
        },
      });
    }

    document.getElementById('authorize-button').onclick = () => {
      tokenClient.requestAccessToken();
      document.getElementById('authorize-button').style.display = 'none';
      document.getElementById('signout-button').style.display = 'block';
    };

    document.getElementById('signout-button').onclick = () => {
      accessToken = null;
      document.getElementById('authorize-button').style.display = 'block';
      document.getElementById('signout-button').style.display = 'none';
      document.getElementById('content').innerText = '';
    };

    function makeApiCall() {
      if (!accessToken) return;

      fetch('https://people.googleapis.com/v1/people/me?personFields=names', {
        headers: {
          Authorization: 'Bearer ' + accessToken,
        },
      })
      .then((response) => response.json())
      .then((data) => {
        var name = data.names[0].givenName;
        document.getElementById('content').innerText = 'Hello, ' + name + '!';
      })
      .catch((error) => console.error(error));
    }

    window.onload = fetchSecrets;
  </script>
</body>
</html>
