<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <style>
      body {
        font-size: 2em;
      }
    </style>
  </head>
  <body>
    <!-- Add a button for the user to click to initiate auth sequence -->
    <button id="authorize-button" style="visibility: hidden;">Authorize</button>
    <button id="signout-button" style="visibility: hidden;">Sign Out</button>

    <script type="text/javascript">
      var clientId; // replace with your client ID
      var apiKey;
      var scopes = 'https://www.googleapis.com/auth/userinfo.profile';

      var tokenClient;
      var accessToken = null;

      // 서버에서 secrets(apiKey, clientId)를 가져옴
      async function fetchSecrets() {
        try {
          const response = await fetch('http://localhost:3001/api/secrets');
          const secrets = await response.json();
          clientId = secrets.clientId;
          apiKey = secrets.apiKey;
          console.log('Secrets fetched:', clientId, apiKey);

          // secrets을 가져온 후에 gapi 및 gis 클라이언트를 초기화
          gapiLoaded();
          gisLoaded();
        } catch (error) {
          console.error('Error fetching secrets:', error);
        }
      }

      function gapiLoaded() {
        gapi.load('client', initializeGapiClient);
        console.log("gapi.load!")
      }

      function initializeGapiClient() {
        gapi.client.init({
          apiKey: apiKey, // replace with your API key
          discoveryDocs: ['https://people.googleapis.com/$discovery/rest?version=v1'],
        });
        console.log("gapi.client.init!")
      }

      function gisLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: clientId,
          scope: scopes,
          callback: (tokenResponse) => {
            accessToken = tokenResponse.access_token;
            console.log("gisLoaded")
            makeApiCall();
          },
        });
        console.log("authorize-button visible")
        document.getElementById('authorize-button').style.visibility = 'visible';

        // 버튼 클릭 시 handleAuthClick 함수를 호출하도록 설정
        document.getElementById('authorize-button').onclick = handleAuthClick;

        // Sign Out 버튼에 handleSignoutClick 연결
        document.getElementById('signout-button').onclick = handleSignoutClick;
      }


      function handleAuthClick() {
        if (!accessToken) {
          tokenClient.requestAccessToken();
          console.log("requestAccessToken!")
        }
      }

      function handleSignoutClick() {
        accessToken = null;
        document.getElementById('authorize-button').style.visibility = 'visible';
        document.getElementById('signout-button').style.visibility = 'hidden';
        document.getElementById('content').innerHTML = '';
      }

      function makeApiCall() {
        gapi.client.people.people
          .get({
            resourceName: 'people/me',
            personFields: 'names,photos',
          })
          .then(function (response) {
            var profile = response.result;
            var heading = document.createElement('h4');
            var image = document.createElement('img');
            image.src = profile.photos[0].url;
            heading.appendChild(image);
            heading.appendChild(
              document.createTextNode(profile.names[0].displayName)
            );
            document.getElementById('content').appendChild(heading);

            document.getElementById('authorize-button').style.visibility = 'hidden';
            document.getElementById('signout-button').style.visibility = 'visible';
          });
      }

      window.onload = fetchSecrets;
    </script>

    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>

    <div id="content"></div>
    <p>Retrieves your profile name using the Google People API.</p>
  </body>
</html>
