<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8' />
  <title>Google Calendar API with New Identity Services</title>
  <style>
    #info {
      border: 1px solid black;
      padding: 0.25em;
      margin: 0.5em 0;
    }
  </style>
  <!-- Load Google Identity Services client -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <script>
    var clientId;
    var apiKey;
    var scopes = 'https://www.googleapis.com/auth/calendar';
    var tokenClient;
    var accessToken = null;

    // The Calendar event resource to create
    var resource = {
      "summary": "Appointment",
      "location": "Somewhere",
      "start": {
        "dateTime": "2024-10-05T10:00:00.000+09:00"
      },
      "end": {
        "dateTime": "2024-10-05T10:25:00.000+09:00"
      }
    };

    // 서버에서 secrets(apiKey, clientId)를 가져옴
    async function fetchSecrets() {
        try {
            const response = await fetch('http://localhost:3001/api/secrets');
            const secrets = await response.json();
            clientId = secrets.clientId;
            apiKey = secrets.apiKey;

            console.log('Secrets fetched:', clientId, apiKey);
            // secrets을 가져온 후에 gapi 클라이언트를 초기화
            gapi.load('client', initClient);

        } catch (error) {
            console.error('Error fetching secrets:', error);
            document.getElementById('info').innerText = 'Error fetching API credentials.';
        }
    }

    function initClient() {
      gapi.client.init({
        apiKey: apiKey
      }).then(function() {
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: clientId,
          scope: scopes,
          callback: (response) => {
            if (response.error !== undefined) {
              console.error("Error obtaining access token:", response);
              return;
            }
            accessToken = response.access_token;
            makeRequest();
          }
        });
      });
    }


    function signIn() {
      tokenClient.requestAccessToken({ prompt: 'consent' });
    }

    // Make a request to create a Google Calendar event
    function makeRequest() {
      if (!accessToken) {
        console.log("Access token is missing. User needs to sign in.");
        return;
      }

      gapi.client.request({
        'path': '/calendar/v3/calendars/primary/events',
        'method': 'POST',
        'body': resource
      }).then(function(resp) {
        writeResponse(resp.result);
      }, function(error) {
        console.error("Error creating calendar event: ", error);
      });
    }

    // Display the response after the calendar event is created
    function writeResponse(response) {
      console.log(response);
      var creator = response.creator.email;
      var calendarEntry = response.htmlLink;
      var infoDiv = document.getElementById('info');
      var infoMsg = document.createElement('P');
      infoMsg.appendChild(document.createTextNode('Calendar entry successfully created by ' + creator));
      infoDiv.appendChild(infoMsg);
      var entryLink = document.createElement('A');
      entryLink.href = calendarEntry;
      entryLink.appendChild(document.createTextNode('View the Calendar entry'));
      infoDiv.appendChild(entryLink);
    }

    window.onload = fetchSecrets;

  </script>

  <script src="https://apis.google.com/js/api.js"></script>

</head>

<body>
  <p>
    This sample creates a Calendar entry for the logged-in user on
    Saturday, Oct 5, 2024, from 10:00 to 10:25.
  </p>
  <button id="rpc" onclick="signIn();">Sign in</button>
  <button id="rest" onclick="makeRequest();">Make Request</button>
  <div id="info"></div>
</body>
</html>
